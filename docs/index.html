<!DOCTYPE html>
<html>
<head>
<title>Basic Character Sheet</title>
<script src="https://cdn.jsdelivr.net/npm/vue"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script> 
</head>

<body>

<div id="app">
  <div>
    <div>
      <span v-for="(val, infoName, index) in character.info">
        <b>{{upperFirst(infoName)}}</b>: <linkable v-model="val"></linkable>&nbsp;
      </span>
    </div>
    <div v-for="(val, attr, index) in character.attrs">
      <label>{{upperFirst(attr)}}: <input type="text" v-model="character.attrs[attr]" ></label> + {{attrMod(val)}}
    </div>
    
  </div>
  <div>
    <calcabledisplay :name="'Init'" :attrs="character.attrs" v-model="character.init"></calcabledisplay>
  </div> 
  <div>
    <h4>Attacks</h4>
    <label>Base Attack Bonus: <input type="text" v-model="character.offense.bab" ></label>
    <ul>
      <li>Melee: {{parseInt(character.offense.bab) + attrMod(character.attrs.str)}}  = {{character.offense.bab}} (bab) + {{attrMod(character.attrs.str)}} (str)</li>
      <li>Ranged: {{parseInt(character.offense.bab) + attrMod(character.attrs.dex)}} = {{character.offense.bab}} (bab) + {{attrMod(character.attrs.dex)}} (dex)</li>
      <li>CMB: {{parseInt(character.offense.bab) + attrMod(character.attrs.str) + parseInt(character.offense.size)}}  = {{character.offense.bab}} (bab) + {{attrMod(character.attrs.str)}} (str) + {{character.offense.size}} (size)
    </ul>
  </div>
  <div>
    <h4>Defense</h4>
    <ul>
      <li>AC</li>
      <li>Touch AC</li>
      <li>CMD</li>
    </ul>
    <div v-for="(val, save, index) in character.saves">
      <calcabledisplay :name="save" :attrs="character.attrs" v-model="character.saves[save]"></calcabledisplay>
    </div>
  </div>
  <hr>
  {{ character }}
</div>


<script type="text/javascript">



const calcableDisplay = Vue.component('calcabledisplay', {
  props: ['name', 'value', 'attrs'],
  computed: {
    total: function(){
      return this.calculateVal(this.value);
    }
  },
  methods: {
    calculateVal: function(obj){
      let sum = 0
      for(const key in obj){
        if(key == 'stat'){
          let statNum = this.attrMod(this.attrs[obj[key]])
          sum += statNum;
        }else{
          sum += Number.parseInt(obj[key])
        }
      }
      return sum;
    },
    attrMod: function(attr){
      return Math.floor( (attr/2) ) - 5
    },
    showStatMod: function(val){
      if( this.attrs[val] ) {
        return this.attrMod(this.attrs[val])
      }
      return val;
    }
  },
  template: `<span>
    <label>{{name}}: {{total}} = <span v-for="(val, key, index) in value"> <i v-if="index > 0">+</i> {{showStatMod(val)}} ( <span v-if="key == 'stat'">{{val}}</span> <span v-if="key != 'stat'">{{key}}</span>) </span></label>
  </span>`
})

const linkable = Vue.component('linkable', {
  props: ['value'],
  computed: {
    title: function(){
      let newString = String(this.value);
      let splitStr = newString.split('|');
      return splitStr[0];
    },
    link: function(){
      let retVal;
      let newString = String(this.value);
      let splitStr = newString.split('|');
      if (splitStr.length > 1 && splitStr[1].indexOf('http') > -1){
        retVal = splitStr[1]
      }
      return retVal;
    }
  },
  template: `<span>
  <a v-if="link" :href="link">{{title}}</a>
  <span v-if="!link">{{title}}</span>
  </span>`
})

const app = new Vue({
  el: '#app',
  data: {
    character: {}
  },
  created: function(){
    let $vm = this;
    axios.get('characters/TK.json').then(function(response){
      $vm.character = response.data
    })
  },
  methods: {
    upperFirst: function(str){
      return str.charAt(0).toUpperCase() + str.substr(1)
    },
    calculateVal: function(obj) {
      let sum = 0
      for(const key in obj){
        if(key == 'stat'){
          let statNum = this.attrMod(this.character.attrs[obj[key]])
          sum += statNum;
        }else{
          sum += Number.parseInt(obj[key])
        }
      }
      return sum;
    },
    attrMod: function(attr){
      return Math.floor( (attr/2) ) - 5
    }
  }
})
</script>

</body>

</html>

